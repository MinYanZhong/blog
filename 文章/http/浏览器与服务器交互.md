### 浏览器解析URL
- 自动扩展URL

    浏览器在用户提交url时候，或者在用户尝试输入url时，浏览器会根据主机名与访问历史自动补全url。

- URL相对路径转换

    如果url是相对url，先要解析url相对引用，把相对url解析成绝对url路径。![解析详情][1]

- 转义URL
    url使用US-ASCII码来传输。当查询遇到一些特殊字符，如空格，汉字，特殊符号会经过浏览器编码转义。
    编码以%开头，后面接两个ASCII码的十六进制数

- 解析URL

    把url解析成9部分组件
    - 组件名:说明:默认值
    1. 方案:协议:无
    2. 用户:访问特定资源需要的用户名:匿名
    3. 密码:用户名对应密码:<E-mail>地址
    4. 主机:IP地址或者域名:无
    5. 端口:资源服务器监听端口号:每个方案特有(http是80)
    6. 路径:url路径可以分为若干段,每段都有特有组件:无
    7. 参数:某些方案用这个组件指定输入参数.与路径之间用;分隔,格式:参数名/值对
    8. 查询:传递参数来激活应用程序.没有固定格式,用?与url其他部分分隔
    9. 片段:一小片或者一部分资源名.不会传递给服务器,用#与url其他部分分隔。

### 域名解析
如果解析主机是IP地址，省略此步骤。如果解析的主机是域名。会经过以下几个步骤：

- 浏览器搜索自身的DNS缓存,看是否有www.baidu.com对应的条目，如果有且没有过期则停止搜索解析到此结束。

- 如果没有找到对应的条目，那么浏览器会搜索操作系统的DNS缓存,如果找到且没过期则停止搜索解析到此结束.

- 如果在系统的DNS缓存也没有找到，那么尝试读取hosts文件，看有没有该域名对应的IP地址，如果有则停止搜索解析到此结束。

- 如果在hosts文件中也没有找到对应的条目，首先会找TCP/IP参数中设置的首选DNS服务器，在此我们叫它本地DNS服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。

- 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。

- 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地DNS就把请求发至13台根DNS，根DNS服务器收到请求后会判断这个域名(.com)是谁来授权管理，并会返回一个负责该顶级域名服务器的一个IP。本地DNS服务器收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找qq.com域服务器，重复上面的动作，进行查询，直至找到www.qq.com主机。

- 如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

![域名映射][2]

拿到IP，端口号，开始发起请求。

### 中间介质
每条请求可能会通过以下几个介质。
#### 网卡
- 串行/并行转换
网卡和局域网之间的通信是通过电缆或双绞线以串行传输方式进行的。而网卡和计算机之间的通信则是通过计算机主板上的I/O总线以并行传输方式进行。网卡要进行串行/并行转换。
- 数据的封装与解封
发送时将终端交下来的数据加上首部和尾部，成为以太网的帧。接收时将以太网的帧剥去首部和尾部，然后送交给终端。
#### 交换机/网桥
- 数据不会经过任何处理直接传递。
- 数据链路层的连接设备。一般用于互连相同类型的LAN（局域网连接）。
- 交换机和网桥的不同在于：交换机端口数较多；交换机的数据传输效率较高。
#### 网关/路由器
- 如果客户端与服务器使用不同协议，网关可以做协议转换。
- 有些网关服务器就是web资源服务器。
- 数据经过此处从局域网传递给广域网。
- 应用层的连接设备。它可以将具有不相容的地址格式的网络相连起来。
#### 隧道
- 隧道服务器可以通过HTTP应用程序访问非HTTP协议的应用程序
- 使用隧道服务器的最常见原因就是：需要在HTTP连接中嵌入非HTTP流量，这样，这类流量就可以穿过只允许Web流量通过的防火墙了。

#### 中继
- 是没有完全遵循HTTP规范的简单HTTP代理。
- 中继负责处理HTTP中建立连接的部分，然后对字节进行盲转发。

### HTTP事物
##### 代理/反向代理(负载均衡)
- 代理
通过一台中介服务器来和远程服务器发送请求。比如用户与中介服务器，中介服务器与远程服务器的连接速度都很快，但是用户与远程服务器无法连接的情况。
    - 用户IP报文的目的IP = 代理服务器IP
    - 用户报文端口号 = 代理服务器监听端口号
    - HTTP消息里的URL要提供服务器的链接
    - 代理服务器可以根据服务器里的链接与服务器直接通信
    - 服务器返回给代理，代理返回给客户端

- 反向代理
用户和负载均衡设备直接通信，也意味着用户做服务器域名解析时，解析得到的IP其实是负载均衡的IP，而不是服务器的IP，这样有一个好处是，当新加入/移走服务器时，仅仅需要修改负载均衡的服务器列表，而不会影响现有的服务。
    - 需要有一个负载均衡设备来分发用户请求，将用户请求分发到空闲的服务器上
    - 服务器返回自己的服务到负载均衡设备
    - 负载均衡将服务器的服务返回用户

##### 网卡/防火墙，内核的TCP/IP协议栈
请求到达服务器，依次经过服务器：

- 网卡转换：将以太网的帧剥去首部和尾部，然后送交给服务器。
- 防火墙：对不符合的协议进行过滤。
- 内核的TCP/IP协议栈：进入栈内暂存协议。

接着，在某一个时刻（下一轮询），协议栈内协议依次执行。

##### TCP/IP
- 如果浏览器url没有显示指定端口号。在tcp/ip执行前，浏览器先会获得服务端口号。

- 建立起三次握手
1. 浏览器 向DNS服务器发出查询请求
1. DNS服务器返回应答
1. 浏览器（192.168.2.33）向服务器（220.181.50.118）发出连接请求。此为TCP三次握手第一步，为SYN，seq:X （x=0）
1. 服务器（220.181.50.118）回应了浏览器（192.168.2.33）的请求，并要求确认，此时为：SYN，ACK，此时seq：y（y为0），ACK：x+1（为1）。此为三次握手的第二步
1. 浏览器（192.168.2.33）回应了服务器（220.181.50.118）的确认，连接成功。为：ACK，此时seq：ACK：y+1（为1）。此为三次握手的第三步
1. 浏览器（192.168.2.33）发出一个页面HTTP请求
1. 服务器（220.181.50.118）确认
1. 服务器（220.181.50.118）发送数据
1. 客户端浏览器（192.168.2.33）确认
1. 客户端（192.168.2.33）发出一个图片HTTP请求
1. 服务器（220.181.50.118）发送状态响应码200 OK
1. 响应完毕后，浏览器向服务器发出结束请求，FIN
1. 服务器返回结束请求确认，FIN-ACK
1. 浏览器回应服务器确认，为ACK，连接关闭

    - *FIN：结束标志-带有该标志置位的数据包用来结束一个TCP回话，但对应端口仍处于开放状态，准备接收后续数据。
    - *SYN：同步标志-同步序列编号(Synchronize Sequence Numbers)栏有效。该标志仅在三次握手建立TCP连接时有效。它提示TCP连接的服务端检查序列编号，该序列编号为TCP连接初始端(一般是客户端)的初始序列编号。在这里，可以把 TCP序列编号看作是一个范围从0到4，294，967，295的32位计数器。通过TCP连接交换的数据中每一个字节都经过序列编号。在TCP报头中的序列编号栏包括了TCP分段中第一个字节的序列编号。
    - *ACK：确认标志-确认编号(Acknowledgement Number)栏有效。大多数情况下该标志位是置位的。TCP报头内的确认编号栏内包含的确认编号(w+1，Figure-1)为下一个预期的序列编号，同时提示远端系统已经成功接收所有数据。

- 延迟确认

    TCP实现了自己的确认机制保证数据成功传输.这个机制的工作过程是这样的:

    - 赋予每个TCP段一个序列号和完整性校验和,发送出去。
    - 服务器收到以后,发送一个小的确认分组。
    - 客户端如何没有在指定时间内收到确认分组,则认为分组已经损坏,并重新发送数据。

    由于确认报文很小,可以将返回的确认信息与数据分组结合.而延迟确认就是:HTTP服务器会在一个特定时间内将输出确认存储到缓冲区中,寻找可以捎带确认的输出数据分组.如;如果没有,则单独发送.

    这与HTTP具有双峰特征的请求--应答行为结合,导致捎带确认的可能性降低.这种回传分组不总是那么多,所以该算法会引入相当大的时延.根据平台的差异,可以调整或者禁用该算法.

- TCP慢启动

    TCP数据传输的性能还取决于连接的使用期(age).TCP连接会随时间进行自我"调谐",性能会从最初的限制到提高传输速度.这被称为TCP慢启动(slow start ),用于防止过载和拥塞.

    但这种行为限制了一个TCP端点在任意时刻可以传输的分组数量.发送的分组数量限制是随着时间和一次次成功接受分组而减少的(就是说,分组数量越来越多).这叫做打开拥塞窗口.

    由于这种特性的存在,新连接的传输速度总是比较慢的,于是引入了重用先存连接的工具,这就是稍后介绍的持久连接.

- Nagle算法

    TCP有一个数据流端口,可以放入任意大小的数据.但是如果发送大量包含少量数据的分组,则会导致性能严重下降。

    而Negle算法则试图在发送一个分组之前,绑定大量TCP数据,以提高网络的效率.该算法鼓励发送全尺寸的段(LAN上是1500字节,www上是几百字节).只有其他分组都被确认以后,该算法才会允许发送非全尺寸的分组 ;如果其他分组仍在传输中,那一部分数据就会缓存起来;只有积累的尺寸足够,或者有挂起分组被确认的时候,其才会将缓存的数据发送出去。

    该算法会引发多种性能问题:

    - 小的HTTP报文可能无法塞满全尺寸分组,会一直等待其他数据而导致时延。
    - 该算法会阻止数据发送,直到有确认分组到达;但确认分组自身由于延迟确认算法会导致时延。

    所以,HTTP程序员会在栈中设置参数TCP_NODELAY禁用该算法.但这需要保证写入大块数据!

- TIME_WAIT积累与端口耗尽

    这是严重的性能问题,会影响性能基准.虽然较少出现,但是遇到性能基准问题时,通常是这个问题.且结果特别糟糕。

    当某个TCP连接关闭时,内存中会维持一个小控制块,记录最近的TCP连接的端口号和IP,会维持一段时间(2分钟左右),通常是所估计的最大分段使用期的两倍(成为2MSL)。

    但是,现在高速路由的出现导致重复分组几乎不可能在关闭连接的几分钟之后,出现在服务器上.所以,有的操作系统会改小这个值.但要小心:分组确实会被赋值,如果来自之前的复制分组插入连接值相同的新TCP流,则会破坏TCP数据。

    在性能基准环境下,这个2MSL的连接关闭延迟会成为大问题.由于:

    - 测试的机子只有几台,IP数量受限。
    - 服务器在默认端口上监听,端口号也受限了。

    假设只有一台测试用机器,这样四个值(源IP地址/目标IP地址/源端口/目标端口)就只有一个值是可变的了.由于可用的端口数量有限,连接率(每秒连接的次数)就会固定在一个较低的次数.要修正该问题,有以下方法:

    - 是增加客户端负载生成及其的数量。
    - 循环使用虚拟IP地址。

    但是,如果在大量连接处于打开状态的情况,或者处于等待状态的连接分配大量控制块的情况,会导致操作系统的速度大降.

##### 请求报文
请参考[报文][3]
##### 服务器处理
请参考[web服务器][4]
##### 响应报文
请参考[报文][5]

### 浏览器渲染
请参考[webkit技术内幕][6]


  [1]: 1.png
  [2]: 2.png
  [3]: https://github.com/antgod/http/tree/master/3.%E6%8A%A5%E6%96%87
  [4]: https://github.com/antgod/http/blob/master/5.%E6%9C%8D%E5%8A%A1%E5%99%A8/readmd.md
  [5]: https://github.com/antgod/http/tree/master/3.%E6%8A%A5%E6%96%87
  [6]: http://download.csdn.net/download/cometwo/9392697